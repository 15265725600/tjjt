<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="description" content="">
		<meta name="keywords" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<title>选择银行卡</title>
		<link rel="stylesheet" href="../assets/css/amazeui.css" />
		<link rel="stylesheet" href="../assets/css/common.css" />
		<link rel="stylesheet" href="../assets/css/my.css" />
	</head>

	<body>
		<!--header部分-->
		<header data-am-widget="header" class="am-header header-white border-b">
			<div class="am-header-left am-header-nav">
				<a href="javascript:history.back()" class="">
					<i class="_back"></i>
				</a>
			</div>
			<h1 class="am-header-title">
	       选择银行卡
	      </h1>
			<div class="am-header-right am-header-nav">
				<a href="javascript:;" class="confirm">
					<span class="am-header-nav-title gray" style="font-size:14px;">
	              确定
	              </span>
				</a>
			</div>
		</header>
		<div class="c-container box-background">
			<ul class="my-back-list">
				<script type="text/html" id="back_list">
					{{each listItems as item index}}
					<li class="back-item clearfix">
						<div class="item-left am-fl"></div>
						<div class="item-right">
							<p>{{item.bankName}}</p>
							<p class="gray card-phone">{{item.bankCardNo}}</p>

						</div>
						<input type="radio" class="mt am-fr" name="radio1" data="{{item.bankCardNo}}" sort="{{item.cardType}}" />

					</li>
					{{/each}}
				</script>
			</ul>
		</div>
		<!--手机验证码model-->
		<div class="am-modal am-modal-alert xp-modal" tabindex="-1" id="y-pay">
			<div class="am-modal-dialog">
				<form class="am-form" method="post" action="">
					<div class="am-modal-hd posr" id="modal-pay">

					</div>
					<div class="am-modal-bd">
						<div class="am-form-group">
							<input type="password" id="pwd" placeholder="请输入手机验证码" />
						</div>
					</div>
					<div class="am-modal-footer">
						<span class="am-modal-btn" data-am-modal-confirm>确定</span>
					</div>
				</form>
			</div>
		</div>
		</div>

	</body>
	<script src="../assets/js/jquery.min.js"></script>
	<script src="../assets/js/amazeui.js"></script>
	<script src="../assets/js/swiper.min.js"></script>
	<script src="../assets/js/dropload.min.js"></script>
	<script src="../assets/js/template.js"></script>
	<script src="../assets/js/common.js"></script>
	<script src="../assets/js/md5.js"></script>
	<script>
		$("#content-source-container-type-selected span:eq(1)").addClass('getClass')
	</script>
	<script>
		var Height = $(window).height() - $('.am-header').height();
		$('.c-container').height(Height);
		//获取银行卡列表
		var token = getCookie('token');
		var price = GetQueryString('price');
		$.ajax({
			url: reqUrl('bankcar_list'),
			type: 'post',
			dataType: 'json',
			data: {
				token: token
			},
			xhrFields: {
				withCredentials: true
			},
			success: function(data) {
				var back_list = template('back_list', data.infor);
				$('.my-back-list').html(back_list);
				var arrLen = data.infor.listItems;
				var count = 0;
				for(var i = 0; i < arrLen.length; i++) {
					if(arrLen[i].isisSafeCard == false) {
						$('.my-back-list .back-item').eq(i).find('.mt').attr('disabled', true);
						count++;

						if(count == arrLen.length) {
							$('.my-back-list .back-item').eq(i).find('.mt').attr('disabled', false);
						}
					}
				}

				$('.confirm').click(function() {
					var checkItem = $('.mt:checked');
					checkItem.each(function() {
						var bankCardNo = $(this).attr('data');
						var cardType = $(this).attr('sort');
						$.ajax({
							type: 'POST',
							url: "http://localhost:8080/hmapi_jintai/plugins/tonglian_withdrawApply",
							data: {
								token: token,
								bankCardNo: bankCardNo,
								cardType: cardType,
								price: 0
							},
							xhrFields: {
								withCredentials: true
							},
							dataType: 'JSON',
							async: false,
							success: function(data) {
								console.log(data)
								if(data.error_code == 200) {
									window.location.href = preUrl('log/login.html?path=my/choose-bankcard.html');
								} else if(data.success) {

									//通联云账户确认支付接口
									var bizOrderNo = data.infor[0].bizOrderNo;
									var tradeNo = data.infor[0].tradeNo;
									$('#y-pay').modal({
										onConfirm: function() {
											var token = getCookie("token");
											var psw = $("#pwd").val();
											if(psw == "") {
												mask('验证码不能为空');
												return;
											}

											$.ajax({
												type: 'POST',
												url: 'http://localhost:8080/hmapi_jintai/plugins/tonglian_pay',
												data: {
													token: token,
													bizOrderNo: bizOrderNo,
													tradeNo: tradeNo,
													verificationCode: psw,
													consumerIp: 'http://localhost:8080/hmapi_jintai/plugins/tonglian_pay'

												},
												xhrFields: {
													withCredentials: true
												},
												dataType: 'JSON',
												async: false,
												success: function(data) {
													if(data.error_code == 200) {
														window.location.href = preUrl('log/login.html?path=my/choose-bankcard.html');
													} else if(data.success) {

														window.location.href = preUrl('index/pay-success.html?orderID=' + orderID + '');

													} else {
														mask(data.msg);
													}

												},
												error: function(e, request, settings) {
													alert(settings)
												}
											});

										}
									});

								} else {
									mask(data.msg)
								}

							},
							error: function(e, request, settings) {
								alert(settings)
							}
						});

					});
				})

			},
			error: function(e, request, settings) {
				alert(settings)
			}
		});
	</script>

</html>